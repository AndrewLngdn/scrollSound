<html>
<body style="height:4000px">
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
	<script src="buffer-loader.js"></script>

	<script> 

	gainNodes = [];
	sources = [];

	(function($){
		window.onload = init;
		initialized = false;
		var context;
		var bufferLoader;
		// var sources = [];
		// var gainNodes = [];
		var parent;

		function init() {
		// Fix up prefixing
		window.AudioContext = window.AudioContext || window.webkitAudioContext;
		context = new AudioContext();
		$(window).trigger("contextLoaded");

		}

		function loadBuffer(url, offset) {
			var request = new XMLHttpRequest();
			request.open("GET", url, true);
			request.responseType = "arraybuffer";

			request.onload = function() {
				console.log("here");

				context.decodeAudioData(
					request.response,
					function(buffer) {
						if (!buffer) {
							alert('error decoding file data: ' + url);
							return;
						}
						finishedLoading(buffer, offset);
					},
					function(error) {
					console.error('decodeAudioData error', error);
					}
				);
			};


			  request.onerror = function() {
			    alert('BufferLoader: XHR error');
			  }

			  request.send();
		}
		

		function createSource(buffer, offset) {
			var source = context.createBufferSource();
			var gainNode = context.createGain();
			source.buffer = buffer;
			source.loop = true;
			source.connect(gainNode);
			gainNode.connect(context.destination);
			gainNode.gain.value = 0.0;

			attachScrollListener(gainNode, offset);

			return {
			source: source,
			gainNode: gainNode
			};
		}
		function attachScrollListener(gainNode, offset){
			var offset = offset;
			parent.scroll(function(){
				
				var scrollHeight = $(this).scrollTop();
					var gain = Math.max(1 - 0.000001*Math.pow(scrollHeight-offset,2), 0);
					gainNode.gain.value = gain;
					console.log($(this).scrollTop());
			});
		}

		function finishedLoading(buffer, offset) {
			var response = createSource(buffer, offset);
			var gainNode = response.gainNode;
			var source = response.source;
			gainNodes.push(gainNode);
			sources.push(source);
			source.start(0);

			return {
				source: source,
				gainNode: gainNode
			};

		}

		$.fn.scrollSound = function(url, height) {
			parent = this;
			$(window).on('contextLoaded', function(){
				console.log(height);
				loadBuffer(url, height);

			})
			return this;
		}
	})(jQuery);
		
		$(document).scrollSound("pptwaves.mp3", 500);
		$(document).scrollSound("forest.mp3", 1500);
	</script>
	
</body>
</html>

